<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Pascal to Rust Migration Plan for Lifelihood • lifelihood</title><script src="lightswitch.js"></script><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet"><link href="deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><link href="extra.css" rel="stylesheet"><meta property="og:title" content="Pascal to Rust Migration Plan for Lifelihood"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">lifelihood</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/lifelihood.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="articles/required-data-format.html">Required data format</a></li>
    <li><a class="dropdown-item" href="articles/setting-up-the-configuration-file.html">Setting up configuration file</a></li>
    <li><a class="dropdown-item" href="articles/how-to-use-lifelihood.html">How to use lifelihood</a></li>
    <li><a class="dropdown-item" href="articles/customize-parameter-boundaries-and-estimation-warning.html">Customize parameter boundaries and estimation warning</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Miscellaneous</h6></li>
    <li><a class="dropdown-item" href="articles/generate-clutch-names.html">Generate clutch names</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Developer</h6></li>
    <li><a class="dropdown-item" href="articles/overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="articles/contributing.html">Contributing</a></li>
    <li><a class="dropdown-item" href="articles/compilation.html">Compilation</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nrode/Lifelihood/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Pascal to Rust Migration Plan for Lifelihood</h1>
      <small class="dont-index">Source: <a href="https://github.com/nrode/Lifelihood/blob/rust/rust.md" class="external-link"><code>rust.md</code></a></small>
    </div>

<div id="pascal-to-rust-migration-plan-for-lifelihood" class="section level1">

<p>This document outlines the plan to rewrite the Pascal computational core of the <code>lifelihood</code> R package in Rust, while maintaining the existing file-based interface between R and the compiled binary.</p>
<div class="section level2">
<h2 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a></h2>
<ol style="list-style-type: decimal"><li><a href="#overview">Overview</a></li>
<li><a href="#current-architecture">Current Architecture</a></li>
<li><a href="#inputoutput-file-formats">Input/Output File Formats</a></li>
<li><a href="#rust-project-structure">Rust Project Structure</a></li>
<li><a href="#module-breakdown">Module Breakdown</a></li>
<li><a href="#implementation-plan">Implementation Plan</a></li>
<li><a href="#build-system-changes">Build System Changes</a></li>
<li><a href="#testing-strategy">Testing Strategy</a></li>
<li><a href="#rust-environment-setup">Rust Environment Setup</a></li>
</ol><hr></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<div class="section level3">
<h3 id="goals">Goals<a class="anchor" aria-label="anchor" href="#goals"></a></h3>
<ul><li>Replace Pascal source code (<code>source/*.pas</code>, <code>source/*.lpr</code>) with equivalent Rust code</li>
<li>Maintain identical file-based I/O interface (R writes text files → binary reads/processes → binary writes output files)</li>
<li>Produce cross-platform binaries: <code>lifelihood-linux</code>, <code>lifelihood-macos</code>, <code>lifelihood-windows.exe</code>
</li>
<li>Preserve all existing functionality: likelihood computation, simulated annealing optimization, MCMC sampling, Hessian computation</li>
</ul></div>
<div class="section level3">
<h3 id="non-goals">Non-Goals<a class="anchor" aria-label="anchor" href="#non-goals"></a></h3>
<ul><li>Changing the R-binary interface (keep using <code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code> calls with stdin arguments)</li>
<li>Adding new features during migration</li>
<li>Using Rust-R bindings (extendr) - keeping file-based approach</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="current-architecture">Current Architecture<a class="anchor" aria-label="anchor" href="#current-architecture"></a></h2>
<div class="section level3">
<h3 id="pascal-source-files">Pascal Source Files<a class="anchor" aria-label="anchor" href="#pascal-source-files"></a></h3>
<table class="table"><colgroup><col width="10%"><col width="80%"><col width="9%"></colgroup><thead><tr><th>File</th>
<th>Purpose</th>
<th>Lines (approx)</th>
</tr></thead><tbody><tr><td><code>lifelihood.lpr</code></td>
<td>Main entry point, argument parsing, orchestration</td>
<td>120</td>
</tr><tr><td><code>Unit1.pas</code></td>
<td>Data reading (<code>readata</code>), config parsing (<code>read_custom</code>)</td>
<td>320</td>
</tr><tr><td><code>Unit2.pas</code></td>
<td>Core algorithms: likelihood (<code>f</code>), optimization (<code>Metropolise</code>, <code>automatic_met</code>), MCMC (<code>promenade</code>), Hessian, output writing</td>
<td>2300</td>
</tr><tr><td><code>Alea.pas</code></td>
<td>Marsaglia random number generator</td>
<td>70</td>
</tr><tr><td><code>fmath.pas</code></td>
<td>Math utilities: exp, log, power, complex numbers</td>
<td>~800</td>
</tr><tr><td><code>fspec.pas</code></td>
<td>Special functions: Gamma, incomplete Gamma, Beta, error function, distributions</td>
<td>~600</td>
</tr><tr><td><code>mathromb.pas</code></td>
<td>Romberg numerical integration</td>
<td>160</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="data-flow">Data Flow<a class="anchor" aria-label="anchor" href="#data-flow"></a></h3>
<pre><code>R (execute_bin.R)
    │
    ├── Writes: input_data.txt (life history data + model spec)
    ├── Writes: param_bounds.txt (parameter boundaries)
    ├── Writes: continuous_var.txt (optional)
    │
    ▼
Pascal Binary (stdin: space-separated arguments)
    │
    ├── Reads input files
    ├── Parses model configuration
    ├── Runs simulated annealing optimization
    ├── Computes Hessian (optional)
    ├── Runs MCMC sampling (optional)
    │
    ▼
    Writes: input_data.out
    │
    ▼
R (read_output.R, parsers.R)
    │
    └── Parses output file sections</code></pre>
</div>
<div class="section level3">
<h3 id="command-line-arguments-24-positional-args-via-stdin">Command Line Arguments (24 positional args via stdin)<a class="anchor" aria-label="anchor" href="#command-line-arguments-24-positional-args-via-stdin"></a></h3>
<pre><code>1.  path_input_data      - Path to data file
2.  path_param_bounds    - Path to parameter bounds file
3.  group_by_group       - Boolean (TRUE/FALSE)
4.  MCMC                 - Number of MCMC samples (0 = disabled)
5.  interval             - Interval between MCMC samples
6.  se.fit               - Compute standard errors (TRUE/FALSE)
7.  saveprobevent        - Save event probabilities (TRUE/FALSE)
8.  fitness              - Fitness reparametrization (TRUE/FALSE)
9.  r                    - Intrinsic rate value
10. seed1-seed4          - Random seeds (4 values)
14. ratiomax             - Max ratio for clutch size senescence
15. tc                   - Critical time for juvenile mortality
16. tinf                 - Maximum censoring time
17. sub_interval         - Sub-interval for integration
18. path_continuous_var  - Path to continuous variables file (or "NULL")
19. ntr                  - Number of temperature reductions
20. nst                  - Number of steps per temperature
21. To                   - Initial temperature
22. Tf                   - Final temperature
23. climbrate            - Cooling rate
24. precision            - Convergence precision</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="inputoutput-file-formats">Input/Output File Formats<a class="anchor" aria-label="anchor" href="#inputoutput-file-formats"></a></h2>
<div class="section level3">
<h3 id="input-data-file-format">Input Data File Format<a class="anchor" aria-label="anchor" href="#input-data-file-format"></a></h3>
<pre><code>*******data struct****
matclutch true|false
covar1 covar2 ...           # covariate names (or "none")
n1 n2 ...                   # number of levels per covariate
****modele******
wei|exp|gam|lgn wei|exp|gam|lgn wei|exp|gam|lgn   # mortality, maturity, reproduction distributions
0|-1 0|-1 ...               # model terms for each of 20 parameters (20 lines)
*******data*********
&lt;cov1&gt; &lt;cov2&gt; sex &lt;t1&gt; &lt;t2&gt; &lt;sex_val&gt; mat &lt;t1&gt; &lt;t2&gt; [&lt;clutch_size&gt;] [pon &lt;t1&gt; &lt;t2&gt; &lt;size&gt;]... mor &lt;t1&gt; &lt;t2&gt;
...</code></pre>
<p><strong>Model term encoding:</strong></p>
<ul><li>
<code>-1</code> = not fitted</li>
<li>
<code>0</code> = intercept only</li>
<li>
<code>1,2,3</code> = covariate effect (factor)</li>
<li>
<code>12,13,23</code> = interaction between covariates</li>
</ul></div>
<div class="section level3">
<h3 id="parameter-bounds-file-format">Parameter Bounds File Format<a class="anchor" aria-label="anchor" href="#parameter-bounds-file-format"></a></h3>
<pre><code>param_name min_bound max_bound
expt_death 1 200
survival_param2 0.001 30
...</code></pre>
</div>
<div class="section level3">
<h3 id="output-file-format">Output File Format<a class="anchor" aria-label="anchor" href="#output-file-format"></a></h3>
<pre><code>---------------------------

datafile= &lt;path&gt;
seed1= X seed2= Y seed3= Z seed4= W
#parameters= N
Likelihood_max= -XXX.XXXXXX
int_param_name X.XXXXXXXX SE.XXXXXXXX
eff_param_name_covar1 X.XXXXXXXX SE.XXXXXXXX
...

inverse of Hessian Matrix [or "(!INVALID)"]
X.XX X.XX X.XX ...
...

MCMCsamples                    # (if MCMC &gt; 0)
LL X.XX X.XX X.XX ...
param1 X.XX X.XX X.XX ...
...

Parameter_Range_Table
expt_death 1.00000000 200.00000000
...
ratiomax X
tinf_(right_censoring) X
tc_(juvenile_period_length) X</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="rust-project-structure">Rust Project Structure<a class="anchor" aria-label="anchor" href="#rust-project-structure"></a></h2>
<pre><code>source/
├── rust/                          # New Rust project root
│   ├── Cargo.toml
│   ├── src/
│   │   ├── main.rs               # Entry point, argument parsing
│   │   ├── lib.rs                # Library root
│   │   ├── io/
│   │   │   ├── mod.rs
│   │   │   ├── input.rs          # Data file parsing
│   │   │   ├── config.rs         # Parameter bounds parsing
│   │   │   ├── output.rs         # Output file writing
│   │   │   └── continuous_var.rs # Continuous variables parsing
│   │   ├── model/
│   │   │   ├── mod.rs
│   │   │   ├── types.rs          # Data structures (Group, Individual, Event, etc.)
│   │   │   ├── distributions.rs  # Survival functions (Weibull, Exponential, LogNormal, Gamma)
│   │   │   ├── likelihood.rs     # Likelihood computation
│   │   │   ├── events.rs         # Event probability calculations
│   │   │   └── link.rs           # Link/delink functions
│   │   ├── optim/
│   │   │   ├── mod.rs
│   │   │   ├── metropolis.rs     # Simulated annealing optimizer
│   │   │   ├── mcmc.rs           # MCMC sampling (promenade)
│   │   │   └── hessian.rs        # Hessian computation &amp; inversion
│   │   ├── math/
│   │   │   ├── mod.rs
│   │   │   ├── special.rs        # Gamma, incomplete gamma, beta, erf
│   │   │   ├── integration.rs    # Romberg integration
│   │   │   └── matrix.rs         # Matrix operations (Gauss-Jordan)
│   │   └── rng/
│   │       ├── mod.rs
│   │       └── marsaglia.rs      # Marsaglia PRNG (exact port for reproducibility)
│   └── tests/
│       ├── integration_tests.rs
│       └── fixtures/             # Test input/output files
├── *.pas                         # Old Pascal files (to be removed after migration)
└── rust.md                       # This file</code></pre>
<hr></div>
<div class="section level2">
<h2 id="module-breakdown">Module Breakdown<a class="anchor" aria-label="anchor" href="#module-breakdown"></a></h2>
<div class="section level3">
<h3 id="id_1-rngmarsaglia---random-number-generator">1. <code>rng::marsaglia</code> - Random Number Generator<a class="anchor" aria-label="anchor" href="#id_1-rngmarsaglia---random-number-generator"></a></h3>
<p><strong>Pascal source:</strong> <code>Alea.pas</code></p>
<p>Port the exact Marsaglia algorithm to ensure reproducible results with same seeds.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Marsaglia <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    u<span class="op">:</span> [<span class="dt">f64</span><span class="op">;</span> <span class="dv">97</span>]<span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    c<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    cd<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    cm<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    ip<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    jp<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="kw">impl</span> Marsaglia <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(seed1<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> seed2<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> seed3<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> seed4<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">Self</span><span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> next(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span>  <span class="co">// Returns uniform [0,1)</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_2-mathspecial---special-mathematical-functions">2. <code>math::special</code> - Special Mathematical Functions<a class="anchor" aria-label="anchor" href="#id_2-mathspecial---special-mathematical-functions"></a></h3>
<p><strong>Pascal source:</strong> <code>fspec.pas</code>, <code>fmath.pas</code></p>
<p>Use the <code>statrs</code> crate for most functions, but verify numerical equivalence:</p>
<ul><li>
<code>gamma(x)</code> - Gamma function</li>
<li>
<code>ln_gamma(x)</code> - Log gamma</li>
<li>
<code>igamma(a, x)</code> - Incomplete gamma (regularized)</li>
<li>
<code>jgamma(a, x)</code> - Complement of incomplete gamma</li>
<li>
<code>erf(x)</code> - Error function</li>
<li>
<code>erfc(x)</code> - Complementary error function</li>
</ul><p><strong>Alternative:</strong> Port Pascal implementations directly if <code>statrs</code> gives different results.</p>
</div>
<div class="section level3">
<h3 id="id_3-mathintegration---numerical-integration">3. <code>math::integration</code> - Numerical Integration<a class="anchor" aria-label="anchor" href="#id_3-mathintegration---numerical-integration"></a></h3>
<p><strong>Pascal source:</strong> <code>mathromb.pas</code>, embedded <code>romb</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> romberg<span class="op">&lt;</span>F<span class="op">&gt;</span>(f<span class="op">:</span> F<span class="op">,</span> lower<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> upper<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> tol<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">f64</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">where</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    F<span class="op">:</span> <span class="bu">Fn</span>(<span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_4-mathmatrix---matrix-operations">4. <code>math::matrix</code> - Matrix Operations<a class="anchor" aria-label="anchor" href="#id_4-mathmatrix---matrix-operations"></a></h3>
<p><strong>Pascal source:</strong> <code>adaptGaussJordan</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> gauss_jordan_invert(matrix<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">f64</span><span class="op">&gt;&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">f64</span><span class="op">,</span> MatrixError<span class="op">&gt;;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_5-modeltypes---data-structures">5. <code>model::types</code> - Data Structures<a class="anchor" aria-label="anchor" href="#id_5-modeltypes---data-structures"></a></h3>
<p><strong>Pascal source:</strong> <code>Unit2.pas</code> type definitions</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Event <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> EventType<span class="op">,</span>  <span class="co">// Sex, Mat, Pon, Mor, Nop</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="kw">pub</span> t1<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    <span class="kw">pub</span> t2<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    <span class="kw">pub</span> debut<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    <span class="kw">pub</span> fin<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    <span class="kw">pub</span> tp<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span>          <span class="co">// clutch size or sex indicator</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> LifeHistory <span class="op">{</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    <span class="kw">pub</span> events<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>Event<span class="op">&gt;,</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    <span class="kw">pub</span> nb_ponte<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Individual <span class="op">{</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="kw">pub</span> life_histories<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>LifeHistory<span class="op">&gt;,</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>    <span class="kw">pub</span> covariates<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">f64</span><span class="op">&gt;,</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SurvivalFunction <span class="op">{</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    <span class="kw">pub</span> name<span class="op">:</span> DistributionType<span class="op">,</span>  <span class="co">// Wei, Exp, Lgn, Gam</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>    <span class="kw">pub</span> vp<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">f64</span><span class="op">&gt;,</span>            <span class="co">// parameters</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Group <span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>    <span class="kw">pub</span> individuals<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>Individual<span class="op">&gt;,</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>    <span class="kw">pub</span> mortality<span class="op">:</span> SurvivalFunction<span class="op">,</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>    <span class="kw">pub</span> maturity<span class="op">:</span> SurvivalFunction<span class="op">,</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>    <span class="kw">pub</span> reproduction<span class="op">:</span> SurvivalFunction<span class="op">,</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>    <span class="kw">pub</span> param_indices<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>ModelParamInst<span class="op">&gt;&gt;,</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> FunctionDescriptor <span class="op">{</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>    <span class="kw">pub</span> variables<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>VarInfo<span class="op">&gt;,</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>    <span class="kw">pub</span> param_descriptors<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>ParamDescriptor<span class="op">&gt;,</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>    <span class="kw">pub</span> best_result<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>    <span class="kw">pub</span> current_result<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_6-modeldistributions---survival-functions">6. <code>model::distributions</code> - Survival Functions<a class="anchor" aria-label="anchor" href="#id_6-modeldistributions---survival-functions"></a></h3>
<p><strong>Pascal source:</strong> <code>surv</code>, <code>survp</code>, <code>survtotpon</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> survival(x<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> dist<span class="op">:</span> <span class="op">&amp;</span>SurvivalFunction<span class="op">,</span> sex<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> tinf<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> survival_with_juvenile(x<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> dist<span class="op">:</span> <span class="op">&amp;</span>SurvivalFunction<span class="op">,</span> sex<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> tc<span class="op">:</span> <span class="dt">f64</span>) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> survival_with_senescence(<span class="op">...</span>) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_7-modelevents---event-probabilities">7. <code>model::events</code> - Event Probabilities<a class="anchor" aria-label="anchor" href="#id_7-modelevents---event-probabilities"></a></h3>
<p><strong>Pascal source:</strong> <code>probevent</code>, <code>censored_mort</code>, <code>censored_mat</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> prob_event(event<span class="op">:</span> <span class="op">&amp;</span>Event<span class="op">,</span> mort<span class="op">:</span> <span class="op">&amp;</span>SurvivalFunction<span class="op">,</span> mat<span class="op">:</span> <span class="op">&amp;</span>SurvivalFunction<span class="op">,</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                  pon<span class="op">:</span> <span class="op">&amp;</span>SurvivalFunction<span class="op">,</span> integrale<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span> sex<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                  hv<span class="op">:</span> <span class="op">&amp;</span>LifeHistory<span class="op">,</span> params<span class="op">:</span> <span class="op">&amp;</span>GlobalParams) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_8-modellikelihood---likelihood-computation">8. <code>model::likelihood</code> - Likelihood Computation<a class="anchor" aria-label="anchor" href="#id_8-modellikelihood---likelihood-computation"></a></h3>
<p><strong>Pascal source:</strong> <code>f</code> function in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> compute_likelihood(fd<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FunctionDescriptor<span class="op">,</span> groups<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [Group]<span class="op">,</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>                         params<span class="op">:</span> <span class="op">&amp;</span>GlobalParams) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_9-optimmetropolis---simulated-annealing">9. <code>optim::metropolis</code> - Simulated Annealing<a class="anchor" aria-label="anchor" href="#id_9-optimmetropolis---simulated-annealing"></a></h3>
<p><strong>Pascal source:</strong> <code>Metropolise</code>, <code>automatic_met</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> MetropolisParams <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    <span class="kw">pub</span> temp0<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>    <span class="kw">pub</span> tempf<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="kw">pub</span> ntr<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="kw">pub</span> nst<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="kw">pub</span> climbrate<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    <span class="kw">pub</span> precision<span class="op">:</span> <span class="dt">f64</span><span class="op">,</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> optimize(fd<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FunctionDescriptor<span class="op">,</span> params<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> MetropolisParams<span class="op">,</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>                groups<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [Group]<span class="op">,</span> rng<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Marsaglia<span class="op">,</span> global<span class="op">:</span> <span class="op">&amp;</span>GlobalParams) <span class="op">-&gt;</span> <span class="dt">f64</span><span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_10-optimmcmc---mcmc-sampling">10. <code>optim::mcmc</code> - MCMC Sampling<a class="anchor" aria-label="anchor" href="#id_10-optimmcmc---mcmc-sampling"></a></h3>
<p><strong>Pascal source:</strong> <code>promenade</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> mcmc_sample(fd<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FunctionDescriptor<span class="op">,</span> params<span class="op">:</span> <span class="op">&amp;</span>MetropolisParams<span class="op">,</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>                   groups<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [Group]<span class="op">,</span> rng<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Marsaglia<span class="op">,</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>                   n_samples<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> interval<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span> global<span class="op">:</span> <span class="op">&amp;</span>GlobalParams)<span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_11-optimhessian---hessian--standard-errors">11. <code>optim::hessian</code> - Hessian &amp; Standard Errors<a class="anchor" aria-label="anchor" href="#id_11-optimhessian---hessian--standard-errors"></a></h3>
<p><strong>Pascal source:</strong> <code>Hessian</code>, <code>calcSE</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> compute_hessian(fd<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FunctionDescriptor<span class="op">,</span> groups<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> [Group]<span class="op">,</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>                       global<span class="op">:</span> <span class="op">&amp;</span>GlobalParams) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">f64</span><span class="op">&gt;&gt;;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> compute_standard_errors(fd<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> FunctionDescriptor<span class="op">,</span> hessian<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">f64</span><span class="op">&gt;&gt;</span>) <span class="op">-&gt;</span> <span class="dt">bool</span><span class="op">;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_12-ioinput---input-file-parsing">12. <code>io::input</code> - Input File Parsing<a class="anchor" aria-label="anchor" href="#id_12-ioinput---input-file-parsing"></a></h3>
<p><strong>Pascal source:</strong> <code>readata</code> in <code>Unit1.pas</code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> parse_data_file(path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>(<span class="dt">Vec</span><span class="op">&lt;</span>Group<span class="op">&gt;,</span> ModelConfig<span class="op">,</span> <span class="dt">Vec</span><span class="op">&lt;</span>Covariate<span class="op">&gt;</span>)<span class="op">,</span> ParseError<span class="op">&gt;;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_13-ioconfig---parameter-bounds-parsing">13. <code>io::config</code> - Parameter Bounds Parsing<a class="anchor" aria-label="anchor" href="#id_13-ioconfig---parameter-bounds-parsing"></a></h3>
<p><strong>Pascal source:</strong> <code>read_custom</code> in <code>Unit1.pas</code></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> parse_bounds_file(path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>ParamDescriptor<span class="op">&gt;,</span> ParseError<span class="op">&gt;;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_14-iooutput---output-file-writing">14. <code>io::output</code> - Output File Writing<a class="anchor" aria-label="anchor" href="#id_14-iooutput---output-file-writing"></a></h3>
<p><strong>Pascal source:</strong> <code>printout_FD</code>, <code>writeparamdescript</code> in <code>Unit2.pas</code></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> write_output(path<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> fd<span class="op">:</span> <span class="op">&amp;</span>FunctionDescriptor<span class="op">,</span> config<span class="op">:</span> <span class="op">&amp;</span>OutputConfig) <span class="op">-&gt;</span> <span class="pp">io::</span><span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;;</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="implementation-plan">Implementation Plan<a class="anchor" aria-label="anchor" href="#implementation-plan"></a></h2>
<div class="section level3">
<h3 id="phase-1-foundation-week-1-2">Phase 1: Foundation (Week 1-2)<a class="anchor" aria-label="anchor" href="#phase-1-foundation-week-1-2"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Set up Rust project structure</strong>
<ul><li>Initialize Cargo project</li>
<li>Define module structure</li>
<li>Add dependencies (<code>statrs</code>, <code>thiserror</code>, etc.)</li>
</ul></li>
<li>
<strong>Port RNG (<code>rng::marsaglia</code>)</strong>
<ul><li>Exact port of Marsaglia algorithm</li>
<li>Unit tests comparing Pascal output with Rust output</li>
</ul></li>
<li>
<strong>Port special functions (<code>math::special</code>)</strong>
<ul><li>Use <code>statrs</code> where possible</li>
<li>Port Pascal implementations where needed for numerical consistency</li>
<li>Extensive unit tests</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="phase-2-data-structures--io-week-3-4">Phase 2: Data Structures &amp; I/O (Week 3-4)<a class="anchor" aria-label="anchor" href="#phase-2-data-structures--io-week-3-4"></a></h3>
<ol start="4" style="list-style-type: decimal"><li>
<strong>Define data types (<code>model::types</code>)</strong>
<ul><li>Port all Pascal record types to Rust structs</li>
<li>Implement <code>Default</code>, <code>Clone</code>, <code>Debug</code> traits</li>
</ul></li>
<li>
<strong>Implement input parsing (<code>io::input</code>, <code>io::config</code>)</strong>
<ul><li>Parse data file with life history records</li>
<li>Parse parameter bounds file</li>
<li>Handle continuous variables file</li>
</ul></li>
<li>
<strong>Implement output writing (<code>io::output</code>)</strong>
<ul><li>Match Pascal output format exactly</li>
<li>Include all sections: seeds, likelihood, effects, Hessian, MCMC, ranges</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="phase-3-core-algorithms-week-5-7">Phase 3: Core Algorithms (Week 5-7)<a class="anchor" aria-label="anchor" href="#phase-3-core-algorithms-week-5-7"></a></h3>
<ol start="7" style="list-style-type: decimal"><li>
<strong>Port survival functions (<code>model::distributions</code>)</strong>
<ul><li>Weibull, Exponential, LogNormal, Gamma</li>
<li>Include male ratio, juvenile mortality, senescence effects</li>
</ul></li>
<li>
<strong>Port event probability (<code>model::events</code>)</strong>
<ul><li>
<code>probevent</code> for each event type</li>
<li>Truncated Poisson for clutch sizes</li>
</ul></li>
<li>
<strong>Port likelihood function (<code>model::likelihood</code>)</strong>
<ul><li>Main <code>f</code> function</li>
<li>Link/delink transformations</li>
<li>Group/individual/event loops</li>
</ul></li>
<li>
<strong>Port numerical integration (<code>math::integration</code>)</strong>
<ul><li>Romberg integration for fitness computation</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="phase-4-optimization-week-8-9">Phase 4: Optimization (Week 8-9)<a class="anchor" aria-label="anchor" href="#phase-4-optimization-week-8-9"></a></h3>
<ol start="11" style="list-style-type: decimal"><li>
<strong>Port Metropolis algorithm (<code>optim::metropolis</code>)</strong>
<ul><li>Simulated annealing with adaptive cooling</li>
<li>Local search refinement</li>
</ul></li>
<li>
<strong>Port MCMC sampling (<code>optim::mcmc</code>)</strong>
<ul><li>
<code>promenade</code> function</li>
<li>Sample storage</li>
</ul></li>
<li>
<strong>Port Hessian computation (<code>optim::hessian</code>)</strong>
<ul><li>Numerical differentiation</li>
<li>Gauss-Jordan matrix inversion</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="phase-5-integration--testing-week-10-11">Phase 5: Integration &amp; Testing (Week 10-11)<a class="anchor" aria-label="anchor" href="#phase-5-integration--testing-week-10-11"></a></h3>
<ol start="14" style="list-style-type: decimal"><li>
<strong>Implement main entry point</strong>
<ul><li>Argument parsing (24 positional args from stdin)</li>
<li>Orchestration of full workflow</li>
</ul></li>
<li>
<strong>Integration testing</strong>
<ul><li>Run Rust binary with same inputs as Pascal</li>
<li>Compare outputs numerically</li>
<li>Regression tests with real datasets</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="phase-6-build-system--deployment-week-12">Phase 6: Build System &amp; Deployment (Week 12)<a class="anchor" aria-label="anchor" href="#phase-6-build-system--deployment-week-12"></a></h3>
<ol start="16" style="list-style-type: decimal"><li>
<strong>Update Makefile</strong>
<ul><li>Cross-compilation targets</li>
<li>Update binary names and paths</li>
</ul></li>
<li>
<strong>Documentation</strong>
<ul><li>Update CLAUDE.md</li>
<li>README updates</li>
</ul></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="build-system-changes">Build System Changes<a class="anchor" aria-label="anchor" href="#build-system-changes"></a></h2>
<div class="section level3">
<h3 id="new-makefile-targets">New Makefile Targets<a class="anchor" aria-label="anchor" href="#new-makefile-targets"></a></h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="dt">RUST_DIR</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">SRC_DIR</span><span class="ch">)</span><span class="st">/rust</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> rust-macos rust-linux rust-windows</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="dv">rust-macos:</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="er">    </span>cd <span class="ch">$(</span><span class="dt">RUST_DIR</span><span class="ch">)</span> &amp;&amp; cargo build --release</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    cp <span class="ch">$(</span><span class="dt">RUST_DIR</span><span class="ch">)</span>/target/release/lifelihood <span class="ch">$(</span><span class="dt">BUILD_DIR</span><span class="ch">)</span>/lifelihood-macos</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="dv">rust-linux:</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="er">    </span>cd <span class="ch">$(</span><span class="dt">RUST_DIR</span><span class="ch">)</span> &amp;&amp; cross build --release --target x86_64-unknown-linux-gnu</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>    cp <span class="ch">$(</span><span class="dt">RUST_DIR</span><span class="ch">)</span>/target/x86_64-unknown-linux-gnu/release/lifelihood <span class="ch">$(</span><span class="dt">BUILD_DIR</span><span class="ch">)</span>/lifelihood-linux</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a><span class="dv">rust-windows:</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a><span class="er">    </span>cd <span class="ch">$(</span><span class="dt">RUST_DIR</span><span class="ch">)</span> &amp;&amp; cross build --release --target x86_64-pc-windows-gnu</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>    cp <span class="ch">$(</span><span class="dt">RUST_DIR</span><span class="ch">)</span>/target/x86_64-pc-windows-gnu/release/lifelihood.exe <span class="ch">$(</span><span class="dt">BUILD_DIR</span><span class="ch">)</span>/lifelihood-windows.exe</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h3>
<ul><li>
<code>cross</code> for cross-compilation: <code>cargo install cross</code>
</li>
<li>Docker for Linux builds (already used)</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests">Unit Tests<a class="anchor" aria-label="anchor" href="#unit-tests"></a></h3>
<p>Each module should have unit tests comparing Rust output with known Pascal output:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>    <span class="kw">fn</span> test_marsaglia_sequence() <span class="op">{</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> rng <span class="op">=</span> <span class="pp">Marsaglia::</span>new(<span class="dv">12345</span><span class="op">,</span> <span class="dv">67890</span><span class="op">,</span> <span class="dv">11111</span><span class="op">,</span> <span class="dv">22222</span>)<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>        <span class="co">// Compare with Pascal output for same seeds</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>        <span class="pp">assert!</span>((rng<span class="op">.</span>next() <span class="op">-</span> <span class="dv">0.123456789</span>)<span class="op">.</span>abs() <span class="op">&lt;</span> <span class="dv">1e-10</span>)<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>    <span class="kw">fn</span> test_weibull_survival() <span class="op">{</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>        <span class="co">// Known values from Pascal</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="integration-tests">Integration Tests<a class="anchor" aria-label="anchor" href="#integration-tests"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Golden file tests</strong>: Run both Pascal and Rust binaries with identical inputs, compare outputs</li>
<li>
<strong>Numerical tolerance</strong>: Allow small floating-point differences (&lt; 1e-8 relative)</li>
<li>
<strong>Real dataset tests</strong>: Use actual <code>lifelihood</code> datasets from tests/testthat/</li>
</ol></div>
<div class="section level3">
<h3 id="r-package-tests">R Package Tests<a class="anchor" aria-label="anchor" href="#r-package-tests"></a></h3>
<p>After migration, all existing R tests should pass:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># Should show PASS 94</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="rust-environment-setup">Rust Environment Setup<a class="anchor" aria-label="anchor" href="#rust-environment-setup"></a></h2>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a></h3>
<ol style="list-style-type: decimal"><li>
<p><strong>Install Rust</strong> (via rustup):</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="ex">curl</span> <span class="at">--proto</span> <span class="st">'=https'</span> <span class="at">--tlsv1.2</span> <span class="at">-sSf</span> https://sh.rustup.rs <span class="kw">|</span> <span class="fu">sh</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="bu">source</span> <span class="va">$HOME</span>/.cargo/env</span></code></pre></div>
</li>
<li>
<p><strong>Verify installation</strong>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="ex">rustc</span> <span class="at">--version</span>  <span class="co"># Should be 1.70+</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="ex">cargo</span> <span class="at">--version</span></span></code></pre></div>
</li>
<li>
<p><strong>Install cross-compilation tools</strong>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="ex">cargo</span> install cross</span></code></pre></div>
</li>
<li>
<p><strong>Install additional targets</strong> (optional, cross handles this):</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="ex">rustup</span> target add x86_64-unknown-linux-gnu</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="ex">rustup</span> target add x86_64-pc-windows-gnu</span></code></pre></div>
</li>
</ol></div>
<div class="section level3">
<h3 id="project-initialization">Project Initialization<a class="anchor" aria-label="anchor" href="#project-initialization"></a></h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="bu">cd</span> source</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="ex">cargo</span> new rust <span class="at">--name</span> lifelihood</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="bu">cd</span> rust</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="recommended-dependencies-cargotoml">Recommended Dependencies (Cargo.toml)<a class="anchor" aria-label="anchor" href="#recommended-dependencies-cargotoml"></a></h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode toml"><code class="sourceCode toml"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="kw">[package]</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">"lifelihood"</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">"2021"</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="dt">statrs</span> <span class="op">=</span> <span class="st">"0.16"</span>          <span class="co"># Statistical functions</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="dt">thiserror</span> <span class="op">=</span> <span class="st">"1.0"</span>        <span class="co"># Error handling</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="dt">anyhow</span> <span class="op">=</span> <span class="st">"1.0"</span>           <span class="co"># Error propagation</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="kw">[profile.release]</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="dt">lto</span> <span class="op">=</span> <span class="cn">true</span>               <span class="co"># Link-time optimization</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a><span class="dt">codegen-units</span> <span class="op">=</span> <span class="dv">1</span>        <span class="co"># Better optimization</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a><span class="dt">panic</span> <span class="op">=</span> <span class="st">"abort"</span>          <span class="co"># Smaller binary</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="development-workflow">Development Workflow<a class="anchor" aria-label="anchor" href="#development-workflow"></a></h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># Build debug version</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="ex">cargo</span> build</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co"># Build release version</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--release</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="ex">cargo</span> test</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co"># Run with arguments (simulating R call)</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"path/to/data.txt path/to/bounds.txt FALSE 0 1 TRUE FALSE FALSE 0 1234 5678 9012 3456 2 0 1000 0.1 NULL 100 20 10 0 1 0.0001"</span> <span class="kw">|</span> <span class="ex">cargo</span> run <span class="at">--release</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a><span class="co"># Format code</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="ex">cargo</span> fmt</span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="co"># Lint</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="ex">cargo</span> clippy</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cross-compilation">Cross-Compilation<a class="anchor" aria-label="anchor" href="#cross-compilation"></a></h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># Linux (from macOS)</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="ex">cross</span> build <span class="at">--release</span> <span class="at">--target</span> x86_64-unknown-linux-gnu</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="co"># Windows (from macOS/Linux)</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="ex">cross</span> build <span class="at">--release</span> <span class="at">--target</span> x86_64-pc-windows-gnu</span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="migration-checklist">Migration Checklist<a class="anchor" aria-label="anchor" href="#migration-checklist"></a></h2>
<ul class="task-list"><li>
<label><input type="checkbox">Phase 1: Foundation</label>
<ul class="task-list"><li><label><input type="checkbox">Cargo project setup</label></li>
<li><label><input type="checkbox">Marsaglia RNG port</label></li>
<li><label><input type="checkbox">Special functions port</label></li>
<li><label><input type="checkbox">Unit tests passing</label></li>
</ul></li>
<li>
<label><input type="checkbox">Phase 2: Data &amp; I/O</label>
<ul class="task-list"><li><label><input type="checkbox">Type definitions</label></li>
<li><label><input type="checkbox">Input file parser</label></li>
<li><label><input type="checkbox">Config file parser</label></li>
<li><label><input type="checkbox">Output file writer</label></li>
<li><label><input type="checkbox">Unit tests passing</label></li>
</ul></li>
<li>
<label><input type="checkbox">Phase 3: Core Algorithms</label>
<ul class="task-list"><li><label><input type="checkbox">Survival functions</label></li>
<li><label><input type="checkbox">Event probabilities</label></li>
<li><label><input type="checkbox">Likelihood computation</label></li>
<li><label><input type="checkbox">Romberg integration</label></li>
<li><label><input type="checkbox">Unit tests passing</label></li>
</ul></li>
<li>
<label><input type="checkbox">Phase 4: Optimization</label>
<ul class="task-list"><li><label><input type="checkbox">Metropolis algorithm</label></li>
<li><label><input type="checkbox">MCMC sampling</label></li>
<li><label><input type="checkbox">Hessian computation</label></li>
<li><label><input type="checkbox">Unit tests passing</label></li>
</ul></li>
<li>
<label><input type="checkbox">Phase 5: Integration</label>
<ul class="task-list"><li><label><input type="checkbox">Main entry point</label></li>
<li><label><input type="checkbox">Integration tests passing</label></li>
<li><label><input type="checkbox">R package tests passing</label></li>
</ul></li>
<li>
<label><input type="checkbox">Phase 6: Deployment</label>
<ul class="task-list"><li><label><input type="checkbox">Makefile updated</label></li>
<li><label><input type="checkbox">Cross-compilation working</label></li>
<li><label><input type="checkbox">Documentation updated</label></li>
<li><label><input type="checkbox">Old Pascal files removed</label></li>
</ul></li>
</ul><hr></div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a></h2>
<div class="section level3">
<h3 id="numerical-precision">Numerical Precision<a class="anchor" aria-label="anchor" href="#numerical-precision"></a></h3>
<p>The Pascal code uses <code>double</code> (64-bit float). Rust’s <code>f64</code> is equivalent. However, pay attention to:</p>
<ul><li>Order of operations (floating-point is not associative)</li>
<li>Edge cases near 0 or infinity</li>
<li>The <code>minus</code> constant (<code>1e-35</code>) used for numerical stability</li>
</ul></div>
<div class="section level3">
<h3 id="global-state">Global State<a class="anchor" aria-label="anchor" href="#global-state"></a></h3>
<p>Pascal uses global variables extensively. In Rust, prefer:</p>
<ul><li>Passing state explicitly through function parameters</li>
<li>Using structs to bundle related state</li>
<li>Consider <code>Rc&lt;RefCell&lt;T&gt;&gt;</code> if truly needed (avoid if possible)</li>
</ul></div>
<div class="section level3">
<h3 id="error-handling">Error Handling<a class="anchor" aria-label="anchor" href="#error-handling"></a></h3>
<p>Pascal uses exceptions sparingly. In Rust:</p>
<ul><li>Use <code>Result&lt;T, E&gt;</code> for recoverable errors</li>
<li>Use <code>Option&lt;T&gt;</code> for optional values</li>
<li>Panic only for truly unrecoverable situations</li>
</ul></div>
<div class="section level3">
<h3 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a></h3>
<p>The Rust version should be at least as fast as Pascal. Key optimizations:</p>
<ul><li>Use <code>--release</code> builds</li>
<li>Profile with <code>cargo flamegraph</code>
</li>
<li>Consider SIMD for likelihood loops (future optimization)</li>
</ul></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicolas Rode, Thomas Lenormand, Joseph Barbier.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

